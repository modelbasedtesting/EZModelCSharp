<!DOCTYPE html>
<html>
	<head>
		<style>
input[type="range"] {
	width:300px;
}
TD { 
	font-family: Arial; 
	font-size: 10pt; 
}
TH {
	font-family: Arial;
	font-size: 12pt;
}
</style>
	</head>
	<body>
	<table border="0" width="100%" height="100%">
		<tr>
			<th colspan="2" id="selectedSvgElementInfo" style="height:20px; color:#e00000"></th> 
		</tr>
		<tr>
			<td width="50">
				<table border="0">
					<tr><td style="text-align:right">18</td><td style="width:50%; background-color:#FF7F7F"></td></tr> 
					<tr><td style="text-align:right">17</td><td style="width:50%; background-color:#97FF2F"></td></tr>
					<tr><td style="text-align:right">16</td><td style="width:50%; background-color:#771FAF"></td></tr>
					<tr><td style="text-align:right">15</td><td style="width:50%; background-color:#4F7FEF"></td></tr>
					<tr><td style="text-align:right">14</td><td style="width:50%; background-color:#8FCF27"></td></tr>
					<tr><td style="text-align:right">13</td><td style="width:50%; background-color:#A71770"></td></tr>
					<tr><td style="text-align:right">12</td><td style="width:50%; background-color:#77EF77"></td></tr>
					<tr><td style="text-align:right">11</td><td style="width:50%; background-color:#CF77CF"></td></tr>
					<tr><td style="text-align:right">10</td><td style="width:50%; background-color:#BF4F4F"></td></tr>
					<tr><td style="text-align:right">9</td><td style="width:50%; background-color:#3737AF"></td></tr>
					<tr><td style="text-align:right">8</td><td style="width:50%; background-color:#008F00"></td></tr>
					<tr><td style="text-align:right">7</td><td style="width:50%; background-color:#EFD700"></td></tr>
					<tr><td style="text-align:right">6</td><td style="width:50%; background-color:#8F008F"></td></tr>
					<tr><td style="text-align:right">5</td><td style="width:50%; background-color:#0000DF"></td></tr>
					<tr><td style="text-align:right">4</td><td style="width:50%; background-color:#FFAF00"></td></tr>
					<tr><td style="text-align:right">3</td><td style="width:50%; background-color:#DF00DF"></td></tr>
					<tr><td style="text-align:right">2</td><td style="width:50%; background-color:#00DF00"></td></tr>
					<tr><td style="text-align:right">1</td><td style="width:50%; background-color:#00AFFF"></td></tr>
					<tr><td style="text-align:right">0</td><td style="width:50%; background-color:#000000"></td></tr>
				</table>
			</td>
			<td>
				<table border="1" rules="none" width="100%" height="100%">
					<tr>
						<td>
<!-- Generated by graphviz -->

<svg id="svgOuter" onmousedown="svgMouseDown(evt)" onmouseup="svgMouseUp(evt)" onmouseleave="svgMouseLeave(evt)" onwheel="svgMouseWheel(evt)" 
 viewBox="0.00 0.00 936.00 139.23" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs><linearGradient id="greenBlueGradient" x1="0%" y1="0%" x2="100%" y2="0%" spreadMethod="pad">    <stop offset="0%" stop-color="yellowgreen" stop-opacity="1"/>    <stop offset="100%" stop-color="lightskyblue" stop-opacity="1"/></linearGradient><linearGradient id="blueGreenGradient" x1="0%" y1="0%" x2="100%" y2="0%" spreadMethod="pad">    <stop offset="0%" stop-color="lightskyblue" stop-opacity="1"/>    <stop offset="100%" stop-color="yellowgreen" stop-opacity="1"/></linearGradient></defs>
<g id="graph0" class="graph" transform="scale(0.87 0.87) rotate(0) translate(4 156.74)">
<title>state_machine</title>
<g id="node0" class="node">
<title>Running.False, Todos.0</title>
<ellipse fill="#f7f5eb" onclick="attr(evt)" stroke="black" cx="67.18" cy="-26.87" rx="67.35" ry="26.74"/>
<text text-anchor="middle" onclick="attr(evt)" x="67.18" y="-30.67" font-family="Times,serif" font-size="14.00">Running.False</text>
<text text-anchor="middle" onclick="attr(evt)" x="67.18" y="-15.67" font-family="Times,serif" font-size="14.00">Todos.0</text>
</g>
<g id="node1" class="node">
<title>Running.True, Todos.0</title>
<ellipse fill="#f7f5eb" onclick="attr(evt)" stroke="black" cx="395.4" cy="-26.87" rx="65.11" ry="26.74"/>
<text text-anchor="middle" onclick="attr(evt)" x="395.4" y="-30.67" font-family="Times,serif" font-size="14.00">Running.True</text>
<text text-anchor="middle" onclick="attr(evt)" x="395.4" y="-15.67" font-family="Times,serif" font-size="14.00">Todos.0</text>
</g>
<g id="edge4" class="edge">
<title>Running.False, Todos.0&#45;&gt;Running.True, Todos.0</title>
<path fill="none" stroke="black" d="M134.59,-26.87C188.43,-26.87 264.27,-26.87 320.12,-26.87"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="320.31,-30.37 330.31,-26.87 320.31,-23.37 320.31,-30.37"/>
<text text-anchor="middle" onclick="attr(evt)" x="232.35" y="-30.67" font-family="Times,serif" font-size="14.00">java &#45;jar apichallenges.jar (0)</text>
</g>
<g id="edge5" class="edge">
<title>Running.True, Todos.0&#45;&gt;Running.True, Todos.0</title>
<path fill="none" stroke="black" d="M386.3,-53.59C386,-63.54 389.04,-71.74 395.4,-71.74 399.38,-71.74 402.06,-68.54 403.44,-63.71"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="406.94,-63.9 404.51,-53.59 399.98,-63.16 406.94,-63.9"/>
<text text-anchor="middle" onclick="attr(evt)" x="395.4" y="-75.54" font-family="Times,serif" font-size="14.00">DeleteTodoById (0)</text>
</g>
<g id="edge7" class="edge">
<title>Running.True, Todos.0&#45;&gt;Running.True, Todos.0</title>
<path fill="none" stroke="black" d="M379.03,-53.03C373.88,-71.47 379.34,-89.74 395.4,-89.74 408.46,-89.74 414.51,-77.68 413.56,-63.27"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="416.94,-62.28 411.78,-53.03 410.04,-63.48 416.94,-62.28"/>
<text text-anchor="middle" onclick="attr(evt)" x="395.4" y="-93.54" font-family="Times,serif" font-size="14.00">GetTodoFromId (0)</text>
</g>
<g id="edge10" class="edge">
<title>Running.True, Todos.0&#45;&gt;Running.True, Todos.0</title>
<path fill="none" stroke="black" d="M374.04,-52.54C361.48,-78.66 368.6,-107.74 395.4,-107.74 418.96,-107.74 427.32,-85.28 420.46,-62.1"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="423.64,-60.61 416.76,-52.54 417.11,-63.13 423.64,-60.61"/>
<text text-anchor="middle" onclick="attr(evt)" x="395.4" y="-111.54" font-family="Times,serif" font-size="14.00">AmendTodoByIdPutMethod (0)</text>
</g>
<g id="node2" class="node">
<title>Running.True, Todos.1</title>
<ellipse fill="#f7f5eb" onclick="attr(evt)" stroke="black" cx="688.51" cy="-26.87" rx="65.11" ry="26.74"/>
<text text-anchor="middle" onclick="attr(evt)" x="688.51" y="-30.67" font-family="Times,serif" font-size="14.00">Running.True</text>
<text text-anchor="middle" onclick="attr(evt)" x="688.51" y="-15.67" font-family="Times,serif" font-size="14.00">Todos.1</text>
</g>
<g id="edge3" class="edge">
<title>Running.True, Todos.0&#45;&gt;Running.True, Todos.1</title>
<path fill="none" stroke="black" d="M460.65,-26.87C505.73,-26.87 566.13,-26.87 613.28,-26.87"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="613.43,-30.37 623.43,-26.87 613.43,-23.37 613.43,-30.37"/>
<text text-anchor="middle" onclick="attr(evt)" x="541.96" y="-30.67" font-family="Times,serif" font-size="14.00">AddTodoWithoutId (0)</text>
</g>
<g id="edge1" class="edge">
<title>Running.True, Todos.1&#45;&gt;Running.True, Todos.0</title>
<path fill="none" stroke="black" d="M632.61,-13.12C623.59,-11.35 614.3,-9.83 605.46,-8.87 549.34,-2.79 534.57,-2.79 478.46,-8.87 472.93,-9.47 467.23,-10.29 461.53,-11.25"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="460.51,-7.88 451.31,-13.12 461.77,-14.76 460.51,-7.88"/>
<text text-anchor="middle" onclick="attr(evt)" x="541.96" y="-12.67" font-family="Times,serif" font-size="14.00">DeleteTodoById (0)</text>
</g>
<g id="edge6" class="edge">
<title>Running.True, Todos.1&#45;&gt;Running.True, Todos.1</title>
<path fill="none" stroke="black" d="M674.85,-53.59C674.41,-63.54 678.96,-71.74 688.51,-71.74 694.48,-71.74 698.5,-68.54 700.56,-63.71"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="704.06,-64.01 702.17,-53.59 697.15,-62.92 704.06,-64.01"/>
<text text-anchor="middle" onclick="attr(evt)" x="688.51" y="-75.54" font-family="Times,serif" font-size="14.00">GetTodosList (0)</text>
</g>
<g id="edge8" class="edge">
<title>Running.True, Todos.1&#45;&gt;Running.True, Todos.1</title>
<path fill="none" stroke="black" d="M664.37,-52.05C655.94,-70.82 663.99,-89.74 688.51,-89.74 708.82,-89.74 717.83,-76.76 715.54,-61.64"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="718.88,-60.62 712.65,-52.05 712.18,-62.63 718.88,-60.62"/>
<text text-anchor="middle" onclick="attr(evt)" x="688.51" y="-93.54" font-family="Times,serif" font-size="14.00">GetHeadersOfTodoFromId (0)</text>
</g>
<g id="node3" class="node">
<title>Running.True, Todos.2</title>
<ellipse fill="#f7f5eb" onclick="attr(evt)" stroke="black" cx="981.62" cy="-26.87" rx="65.11" ry="26.74"/>
<text text-anchor="middle" onclick="attr(evt)" x="981.62" y="-30.67" font-family="Times,serif" font-size="14.00">Running.True</text>
<text text-anchor="middle" onclick="attr(evt)" x="981.62" y="-15.67" font-family="Times,serif" font-size="14.00">Todos.2</text>
</g>
<g id="edge2" class="edge">
<title>Running.True, Todos.1&#45;&gt;Running.True, Todos.2</title>
<path fill="none" stroke="black" d="M753.76,-26.87C798.84,-26.87 859.24,-26.87 906.39,-26.87"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="906.54,-30.37 916.54,-26.87 906.54,-23.37 906.54,-30.37"/>
<text text-anchor="middle" onclick="attr(evt)" x="835.07" y="-30.67" font-family="Times,serif" font-size="14.00">AddTodoWithoutId (0)</text>
</g>
<g id="edge0" class="edge">
<title>Running.True, Todos.2&#45;&gt;Running.True, Todos.1</title>
<path fill="none" stroke="black" d="M925.72,-13.12C916.7,-11.35 907.41,-9.83 898.57,-8.87 842.45,-2.79 827.68,-2.79 771.57,-8.87 766.04,-9.47 760.34,-10.29 754.64,-11.25"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="753.62,-7.88 744.41,-13.12 754.88,-14.76 753.62,-7.88"/>
<text text-anchor="middle" onclick="attr(evt)" x="835.07" y="-12.67" font-family="Times,serif" font-size="14.00">DeleteTodoById (0)</text>
</g>
<g id="edge9" class="edge">
<title>Running.True, Todos.2&#45;&gt;Running.True, Todos.2</title>
<path fill="none" stroke="black" d="M967.96,-53.59C967.51,-63.54 972.07,-71.74 981.62,-71.74 987.59,-71.74 991.61,-68.54 993.67,-63.71"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="997.17,-64.01 995.28,-53.59 990.25,-62.92 997.17,-64.01"/>
<text text-anchor="middle" onclick="attr(evt)" x="981.62" y="-75.54" font-family="Times,serif" font-size="14.00">AmendTodoByIdPostMethod (0)</text>
</g>
<g id="edge11" class="edge">
<title>Running.True, Todos.2&#45;&gt;Running.True, Todos.2</title>
<path fill="none" stroke="black" d="M957.48,-52.05C949.05,-70.82 957.1,-89.74 981.62,-89.74 1001.93,-89.74 1010.94,-76.76 1008.65,-61.64"/>
<polygon fill="black" onclick="attr(evt)" stroke="black" points="1011.99,-60.62 1005.76,-52.05 1005.29,-62.63 1011.99,-60.62"/>
<text text-anchor="middle" onclick="attr(evt)" x="981.62" y="-93.54" font-family="Times,serif" font-size="14.00">AddTodoWithoutId (0)</text>
</g>
</g>
</svg>
            </td>
		</tr>
	</table>
</td>
</tr>
<tr>
	<td></td>
	<td>
		<table>
			<tr>
			    <td>
			    	<table border="1" rules="none">
			    		<tr>
			    			<td style="text-align:center; padding-top:2px; padding-left:2px; padding-right:2px" colspan="3">Transition</td>
			    		</tr>
			    		<tr>
			    			<td style="padding-left:2px"><button onclick="traversalStepBack()">&lt;</button></td>
							<td id="stepTD" style="text-align:center; width:100"><label id="step"></label></td>
						    <td style="padding-right:2px"><button onclick="traversalStepForward()">&gt;</button></td>
						</tr>
						<tr>
							<td style="text-align:center; padding-bottom:2px; padding-left:2px; padding-right:2px" colspan="3"><label id="transitionFloor"></label></td>
						</tr>
					</table>
				</td>
				<td style="width:30px"></td>
				<td>
					<table border="1" rules="none">
						<tr>
						    <td style="padding-top:5px; padding-left:20px;"><button onclick="startTraversal()">&#9654;</button></td>
							<td style="text-align:center; padding-top:5px"><label id="speedLabel">Speed: 1</label></td>
						    <td style="text-align:right; padding-top:5px; padding-right:20px"><button onclick="stopTraversal()">&#9209;</button></td>
						</tr>
			    		<tr>
							<td style="padding-bottom:5px; padding-left:2px; padding-right:2px" colspan="3">1<input type="range" min="1" max="60" oninput="changeSpeed()" value="1" id="traversalSpeed">60</td>
						</tr>
					</table>
				</td>
				<td style="width:30px"></td>
				<td>
					<table>
						<tr>
							<td><button onclick="fitGraph()">FIT GRAPH</button></td>
							<td><input type="checkbox" id="recycleCbox" name="recycleCBox" value="recycleColors"><label for="recycleCbox"> Recycle hitcount colors</label></td>
							<td><button id="btnReset" onclick="reset()">RESET TRAVERSAL</button></td>
						</tr>
						<tr>
							<td colspan="2"><input type="range" min="0" max="75" oninput="updateDisplayAttributes()" value="35" id="subgraphOpacity"></td>
							<td><input type="checkbox" onclick="updateDisplayAttributes()" id="isolateSubgraph"><label for="isolateSubgraph"> Isolate subgraph</label></td>
						</tr>
					</table>
				</td>
		    </tr>
		</table>
	</td>
</tr>
</table>
<script type="text/ecmascript">
var step = -1; // Because step is an index into an array.

const actionNames = ["DeleteTodoById","AddTodoWithoutId","java -jar apichallenges.jar","GetTodosList","GetTodoFromId","GetHeadersOfTodoFromId","AmendTodoByIdPostMethod","AmendTodoByIdPutMethod"];
 
const transitionActions = [0,0,1,1,2,0,3,4,5,6,7,1];
 
const transitionEnabledFlags = [true,true,true,true,false,true,true,true,true,true,true,true];
 
const transitionHitCounts = new Array(12).fill(0);
 
const nodeCount = 4;
 
const traversedEdge = [4,3,8,1,7,10,5,3,2,0,6,2,11,9,9,0,6,1,5,10,7,3,8,2,11,11,9,0,6,8,1,7,10,5,7,5,3,6,8,2,0,1,10,3,2,9,11];
 
const pathEdges = [[4],[3],[8],[1],[7],[10],[5],[3,2,0],[3,2,0],[3,2,0],[6],[2,11],[2,11],[9],[9],[0],[6],[1],[5],[10],[7],[3,8],[3,8],[2,11],[2,11],[11],[9],[0],[6],[8],[1],[7],[10],[5],[7],[5],[3],[6],[8],[2],[0],[1],[10],[3,2,9],[3,2,9],[3,2,9],[11]];
 
const pathNodes = [[1],[2],[2],[1],[1],[1],[1],[1,2,3,2],[1,2,3,2],[1,2,3,2],[2],[2,3,3],[2,3,3],[3],[3],[2],[2],[1],[1],[1],[1],[1,2,2],[1,2,2],[2,3,3],[2,3,3],[3],[3],[2],[2],[2],[1],[1],[1],[1],[1],[1],[2],[2],[2],[3],[2],[1],[1],[1,2,3,3],[1,2,3,3],[1,2,3,3],[3]];
 
const startNode = [0,1,2,2,1,1,1,1,2,3,2,2,3,3,3,3,2,2,1,1,1,1,2,2,3,3,3,3,2,2,2,1,1,1,1,1,1,2,2,2,3,2,1,1,2,3,3];
 
const pathEndNode = [1,2,2,1,1,1,1,2,2,2,2,3,3,3,3,2,2,1,1,1,1,2,2,3,3,3,3,2,2,2,1,1,1,1,1,1,2,2,2,3,2,1,1,3,3,3,3];
 
const subgraphNodes = [[0],[1,2,0],[2,3,1],[3,2]];
 
const subgraphEdges = [[],[1,3,4,5,7,10],[0,1,2,3,6,8],[0,2,9,11]];
 
var c = 0;
var t;
var timer_is_on = 0;

var coverageFloor;

var initialBox = svgOuter.getAttribute("viewBox");
var initialBits = initialBox.split(" ");

const stepElemSize = 18*Math.floor(Math.log10(traversedEdge.length)) + 27;
var stepElem = document.getElementById("stepTD");
stepElem.setAttribute("style", "text-align:center; width:" + stepElemSize.toString() + "px");
setStepText();
assessCoverageFloor();

var selectedSvgElement = undefined;

for (var j=0; j < transitionActions.length; j++)
{
    var action = actionNames[transitionActions[j]];
    var text = document.getElementById("edge" + j.toString()).getElementsByTagName("text");
    if (text.length > 0)
    {
        text[0].innerHTML = action;
    }
}

function changeSpeed(e) {
	document.getElementById("speedLabel").innerHTML = "Speed: " + document.getElementById("traversalSpeed").value.toString();
}

function fitGraph() {
    document.getElementById("svgOuter").setAttribute("viewBox", initialBox);
}

var previousSubgraph = undefined;
var previousFill = undefined;
var currentSubgraph = undefined;

function allComponentsToFullOpacity() {
    for (var i=0; i < transitionHitCounts.length; i++)
    {
        document.getElementById("edge" + i).setAttribute("opacity", "1.0");
    }
    for (var i=0; i < nodeCount; i++)
    {
        document.getElementById("node" + i).setAttribute("opacity", "1.0");
    }
}

function updateDisplayAttributes() {
    if (currentSubgraph == undefined || !document.getElementById("isolateSubgraph").checked)
    {
    	if (previousSubgraph != undefined)
    	{
	    	var ellipse = document.getElementById("node" + previousSubgraph).getElementsByTagName("ellipse")[0];
	    	ellipse.setAttribute("fill", previousFill);
		}
		allComponentsToFullOpacity();
    }
    if (document.getElementById("isolateSubgraph").checked && currentSubgraph != undefined)
    {
    	opacityValue = document.getElementById("subgraphOpacity").value / 100.0;
        for (var i=0; i < transitionHitCounts.length; i++)
        {
            document.getElementById("edge" + i).setAttribute("opacity", subgraphEdges[currentSubgraph].includes(i) ? "1.0" : opacityValue.toString());
        }
        for (var i=0; i < nodeCount; i++)
        {
            document.getElementById("node" + i).setAttribute("opacity", subgraphNodes[currentSubgraph].includes(i) ? "1.0" : opacityValue.toString());
        }

        if (previousSubgraph != undefined)
        {
	        var ellipse = document.getElementById("node" + previousSubgraph).getElementsByTagName("ellipse")[0];
	        ellipse.setAttribute("fill", previousFill);
	    }
        previousSubgraph = subgraphNodes[currentSubgraph][0];
        var ellipse = document.getElementById("node" + previousSubgraph).getElementsByTagName("ellipse")[0];
        previousFill = ellipse.getAttribute("fill");
        ellipse.setAttribute("fill", "#ffff77");
    }
}

function releaseSelection() {
	if (currentSubgraph != undefined)
	{
        currentSubgraph = undefined;
    }
    updateDisplayAttributes();

    if (selectedSvgElement != undefined)
    {
        var text = selectedSvgElement.getElementsByTagName("text");
        if (text && text.length > 0)
        {
            for (var i = 0; i < text.length; i++)
            {
                text[i].setAttribute("fill", "black");
            }
        }
        document.getElementById("selectedSvgElementInfo").innerHTML = " ";
        selectedSvgElement = undefined;
    }
}

function attr(event) {
    releaseSelection();
    var t = event.target;
    var p = t.parentNode;
    selectedSvgElement = p;
    var id = p.getAttribute("id");
    var msg = "";

    switch (id.substring(0,4))
    {
        case "node":
        	var nodenum = id.substring(4);
        	if (currentSubgraph != undefined)
        	{
        		if (currentSubgraph == nodenum)
        		{
        			return;
        		}
        	}
            currentSubgraph = nodenum;
            updateDisplayAttributes();
            var title = p.getElementsByTagName("title");
            if (title && title.length > 0)
            {
                msg += title[0].innerHTML;
            }
            var text = p.getElementsByTagName("text");
            if (text && text.length > 0)
            {
                for (var i=0; i<text.length; i++)
                {
                    text[i].setAttribute("fill", "red");
                }
            }
            break;
        case "edge":
            var text = p.getElementsByTagName("text");
            if (text && text.length > 0)
            {
                msg += text[0].innerHTML;
                text[0].setAttribute("fill", "red");
            }
            break;
        default:
            break;
    }

    document.getElementById("selectedSvgElementInfo").innerHTML = msg;
}

var viewBoxBits = document.getElementById("svgOuter").getAttribute("viewBox").split(" ");
var originalBits = [parseFloat(viewBoxBits[0]), parseFloat(viewBoxBits[1]),
    parseFloat(viewBoxBits[2]), parseFloat(viewBoxBits[3])];
var newBits = originalBits;
var translateScale = newBits[2] / originalBits[2];

function svgMouseDown(event) {
    var t = event.target;
    switch (event.button)
    {
        case 0: // main button, e.g., left on a default setup
            t.onmousemove = svgMouseMove;
            didTranslate = false;
            break;
        case 1: // mouse wheel
            break;
        case 2: // secondary button, e.g., right on a default setup
            break;
        default: // we don't interepret any other mouse buttons, yet
            break;
    }
    // https://www.javascripttutorial.net/javascript-dom/javascript-mouse-events/
}

var mouseMovePreviousX = undefined;
var mouseMovePreviousY = undefined;
var didTranslate = false;

function svgMouseMove(event) {
    didTranslate = true;
    var t = event.target;
    var x = event.clientX;
    var y = event.clientY;
    if (mouseMovePreviousX == undefined || mouseMovePreviousY == undefined)
    {
        mouseMovePreviousX = x;
        mouseMovePreviousY = y;
    }
    else
    {
        var dx = translateScale * 0.5 * (mouseMovePreviousX - x);
        var dy = translateScale * 0.5 * (mouseMovePreviousY - y);
        mouseMovePreviousX = x;
        mouseMovePreviousY = y;
        translateViewBox(dx, dy);
    }
}

var svgRescale = 1.0;
var previousDeltaYWasPositive = true;

function svgMouseWheel(event) {
    didTranslate = true;
    if (event.deltaY > 0)
    {
    	if (previousDeltaYWasPositive)
    	{
	    	svgRescale *= 1.01;
	    }
	    else
	    {
	    	svgRescale = 1.01;
	    }
	    previousDeltaYWasPositive = true;
    }
    else
    {
    	if (previousDeltaYWasPositive)
    	{
    		svgRescale = 0.99;
    	}
    	else
    	{
    		svgRescale *= 0.99;
    	}
    	previousDeltaYWasPositive = false;
    }

    newBox = rescaleViewBox( svgRescale );
}

function svgMouseLeave(event) {
    svgMouseChange(event);
}

function svgMouseUp(event) {
    if (!didTranslate && selectedSvgElement != undefined)
    {
        releaseSelection();
    }
    svgMouseChange(event);
}

function svgMouseChange(event) {
	svgRescale = 1.0;
    didTranslate = false;
    mouseMovePreviousX = undefined;
    mouseMovePreviousY = undefined;
    var t = event.target;
    t.onmousemove = null;
}

function rescaleViewBox(scale) {
    var svgOuter = document.getElementById("svgOuter");
    var viewBox = svgOuter.getAttribute("viewBox");
    var boxBits = viewBox.split(" ");
    var width = parseFloat(boxBits[2]);
    var height = parseFloat(boxBits[3]);
    var xMin = parseFloat(boxBits[0]);
    var yMin = parseFloat(boxBits[1]);

    if (Math.abs(scale - 1.0) < 0.001)
    {
        // do nothing on an almost nothing scale change.
        return;
    }

    xMin += 0.5 * (1.0 - scale) * width;
    yMin += 0.5 * (1.0 - scale) * height;
    width *= scale;
    height *= scale;

    if (width < 20 || height < 20 || width > 5000 || height > 5000)
    {
        return viewBox;
    }

    newBits = [xMin, yMin, width, height];
    translateScale = newBits[2] / originalBits[2];
    xString = xMin.toFixed(2).toString();
    yString = yMin.toFixed(2).toString();
    wString = width.toFixed(2).toString();
    hString = height.toFixed(2).toString();
    var newViewBox = xString + " " + yString + " " + wString + " " + hString;
    svgOuter.setAttribute("viewBox", newViewBox);
    return newViewBox;
}

function translateViewBox(dx, dy) {
    var svgOuter = document.getElementById("svgOuter");
    var viewBox = svgOuter.getAttribute("viewBox");
    var boxBits = viewBox.split(" ");
    var xMin = parseFloat(boxBits[0]) + dx;
    var yMin = parseFloat(boxBits[1]) + dy;
    xString = xMin.toFixed(2).toString();
    yString = yMin.toFixed(2).toString();

    var newViewBox = xString + " " + yString + " " + boxBits[2] + " " + boxBits[3];
    svgOuter.setAttribute("viewBox", newViewBox);
}

function setTransitionFloorText() {
	document.getElementById("transitionFloor").innerHTML = "Hitcount floor: " + coverageFloor;
}

function timedTraversal() {
	c = c + 1;
	traversalStepForward();
	if (timer_is_on)
	{
		var dt = 1000.0 / parseFloat(document.getElementById("traversalSpeed").value);
		t = setTimeout(timedTraversal, Math.round(dt));
	}
}

function startTraversal() {
  if (!timer_is_on) {
    timer_is_on = 1;
    timedTraversal();
  }
}

function stopTraversal() {
  clearTimeout(t);
  timer_is_on = 0;
}

function reset() {
	timer_is_on = 0;
	clearTimeout(t);

    document.getElementById("selectedSvgElementInfo").innerHTML = " ";
    for (var i = 0; i < transitionHitCounts.length; i++)
    {
        transitionHitCounts[i] = 0;
    }
    refreshGraphics("black");

    step = -1; // Because step is an index into an array.
    setStepText();
    assessCoverageFloor();
}

function setStepText() {
	document.getElementById("step").innerHTML = (step+1) + "/" + traversedEdge.length;
}

function refreshGraphics(refreshColor) {
    // Set all path and polygon strokes and stroke-width values to 2,
    // and stroke color to black.  Set the fill to none on all graph nodes.

	// Walk backwards from the current step and set a 
	// rendered flag on each transition as it is encountered.
	// Do not render a transition that has rendered==true.
	var rendered = new Array(transitionHitCounts.length).fill(false);
    var edgesToRender = traversedEdge.length;

    // Before we walk backwards, clear each edge of the lookahead path
    // that is beyond the present edge.
    if (step > -1 && step < traversedEdge.length)
    {
        for (var i=1; i < pathEdges[step].length; i++)
        {
            var index = pathEdges[step][i];
            var hitColor = getHitColor(transitionHitCounts[index]);

            rendered[index] = true;
            edgesToRender--;

            var edge = document.getElementById("edge" + index.toString());
            var path = edge.getElementsByTagName("path");
            if (path.length > 0)
            {
                path[0].setAttribute("stroke-width", "3");
                path[0].setAttribute("stroke", hitColor);
            }
            var poly = edge.getElementsByTagName("polygon");
            if (poly.length > 0)
            {
                poly[0].setAttribute("stroke-width", "3");
                poly[0].setAttribute("fill", hitColor);
                poly[0].setAttribute("stroke", hitColor);
            }
        }
    }

    for (var i = step; i >= 0 && edgesToRender > 0; i--)
    {
    	var edgeIndex = traversedEdge[i];
    	if (rendered[edgeIndex])
    	{
    		continue;
    	}

        // When there are many steps, we will cover all the edges before we
        // get through all the steps, and we can stop looking for edges to
        // paint.  So count down the edges to render to zero, and stop.
        edgesToRender--; 

    	rendered[edgeIndex] = true;
        var hitCount = transitionHitCounts[edgeIndex];
        var hitColor = getHitColor(hitCount);
        var action = actionNames[transitionActions[edgeIndex]];
        var edge = document.getElementById("edge" + edgeIndex.toString());
        var path = edge.getElementsByTagName("path");
        if (path.length > 0)
        {   // for hitCount 0 set the stroke width to 1.
            path[0].setAttribute("stroke-width", hitCount == 0 ? 1 : refreshColor == null ? "3" : "1");
            path[0].setAttribute("stroke", refreshColor == null ? hitColor : refreshColor);
        }
        var poly = edge.getElementsByTagName("polygon");
        if (poly.length > 0)
        {   // for hitCount 0 set the stroke width to 1.
            poly[0].setAttribute("stroke-width", hitCount == 0 ? 1 : refreshColor == null ? "3" : "1");
            poly[0].setAttribute("fill", refreshColor == null ? hitColor : refreshColor);
            poly[0].setAttribute("stroke", refreshColor == null ? hitColor : refreshColor);
        }
        var text = edge.getElementsByTagName("text");
        if (text.length > 0)
        {
            if (hitCount > 0)
            {
                action += " (" + hitCount.toString() + ")";
            }
            text[0].innerHTML = action;
        }
    }

    // Clear all the nodes.
    for (var i = 0; i < nodeCount; i++)
    {
        var node = document.getElementById("node" + i.toString());
        var ellipse = node.getElementsByTagName("ellipse");
        if (ellipse.length > 0)
        {
            ellipse[0].setAttribute("fill", "#f7f5eb");
        }
    }
}

function traversalStepBack() {
	stopTraversal();
    if (step - 1 < -1)
    {
        return;
    }

    if (step > -1)
    {
        transitionHitCounts[traversedEdge[step]]--;
        if (transitionHitCounts[traversedEdge[step]] < coverageFloor)
        {
        	coverageFloor = transitionHitCounts[traversedEdge[step]];
        	setTransitionFloorText();
        }
        refreshGraphics();
    }
    step--;
    traversalStepCommon();
}

function traversalStepForward() {
    if (step + 1 >= traversedEdge.length)
    {
        stopTraversal(); // in case the traversal was running.  Now we can use the back button.
        return;
    }
    step++;
    transitionHitCounts[traversedEdge[step]]++;
    refreshGraphics();
    assessCoverageFloor();
    traversalStepCommon();
}

window.addEventListener( 'keydown', (e) => { 
    var key = 0;


    if (e == null) { key = event.keyCode;}  
    else {  key = e.which;} 


    switch(key) {
        case 37: // left arrow                
          stopTraversal();
          traversalStepBack();
          break;
        case 38: // up arrow          
          break;
        case 39: // right arrow
        	stopTraversal();
        	traversalStepForward();                     
          break;
        case 40: // down arrow 
          break;
    }     
});

function assessCoverageFloor()
{
	var floor = 2000000000;
	for (var i=0; i < transitionHitCounts.length; i++)
	{
		if (transitionEnabledFlags[i] && transitionHitCounts[i] < floor)
		{
			floor = transitionHitCounts[i];
		}
	}
	if (floor != coverageFloor)
	{
		coverageFloor = floor;
		setTransitionFloorText();
	}
}

function traversalStepCommon() {
    setStepText();

    if (step == -1)
    {
        return; // no work to do because we are at the initial state.
    }

    document.getElementById("selectedSvgElementInfo").innerHTML = actionNames[transitionActions[traversedEdge[step]]];

    // Now paint the current path and nodes in light grey
    for (var i = 0; i < pathEdges[step].length; i++)
    {
        var svgEdge = pathEdges[step][i];
        var edge = document.getElementById("edge" + svgEdge.toString());
        var path = edge.getElementsByTagName("path");
        if (path.length > 0)
        {
            path[0].setAttribute("stroke-width", "15");
            path[0].setAttribute("stroke", "lightgrey");
        }
        var poly = edge.getElementsByTagName("polygon");
        if (poly.length > 0)
        {
            poly[0].setAttribute("stroke-width", "15");
            poly[0].setAttribute("fill", "lightgrey");
            poly[0].setAttribute("stroke", "lightgrey");
        }
    }
    for (var i = 0; i < pathNodes[step].length; i++)
    {
        var svgNode = pathNodes[step][i];
        var node = document.getElementById("node" + svgNode.toString());
        var ellipse = node.getElementsByTagName("ellipse");
        if (ellipse.length > 0)
        {
            ellipse[0].setAttribute("fill", "lightgrey");
        }
    }

    // Finally, paint the current transition
    svgEdge = traversedEdge[step];
    edge = document.getElementById("edge" + svgEdge.toString());
    var path = edge.getElementsByTagName("path");
    if (path.length > 0)
    {
        path[0].setAttribute("stroke-width", "15");
        path[0].setAttribute("stroke", "url(#greenBlueGradient)");
    }
    var poly = edge.getElementsByTagName("polygon");
    if (poly.length > 0)
    {
        poly[0].setAttribute("stroke-width", "15");
        poly[0].setAttribute("fill", "url(#greenBlueGradient)");
        poly[0].setAttribute("stroke", "url(#greenBlueGradient)");
    }

    if (startNode[step] == pathEndNode[step])
    {
    	var nodeNum = startNode[step];
    	var node = document.getElementById("node" + nodeNum.toString());

        var ellipse = node.getElementsByTagName("ellipse");
        if (ellipse.length > 0)
        {
            if (pathEdges[step].length == 1)
            {
                // This is a self loop with the path coming out of the 
                // start node, going into the end node, so make the 
                // node blue to green.
                ellipse[0].setAttribute("fill", "url(#blueGreenGradient)");
            }
            else
            {
                // This is probably the path coming into the end node,
                // so make the node green to blue.
                ellipse[0].setAttribute("fill", "url(#greenBlueGradient)");

            }
        }
    }
    else
    {
        var start = startNode[step];
        var node = document.getElementById("node" + start.toString());
        var ellipse = node.getElementsByTagName("ellipse");
        if (ellipse.length > 0)
        {
            ellipse[0].setAttribute("fill", "yellowgreen");
        }

        var pathEnd = pathEndNode[step];
        node = document.getElementById("node" + pathEnd.toString());
        ellipse = node.getElementsByTagName("ellipse");
        if (ellipse.length > 0)
        {
            ellipse[0].setAttribute("fill", "lightskyblue");
        }
    }
}

function getHitColor(hitCount) {
	var caseNum = document.getElementById("recycleCbox").checked ? hitCount%19 : hitCount;

    switch (caseNum)
    {
        case 0:
            if (hitCount != 0)
            {
                return "#FF7F7F";
            }
            return "#000000";
        case 1:
            return "#00AFFF";
        case 2:
            return "#00DF00";
        case 3:
            return "#DF00DF";
        case 4:
            return "#FFAF00";
        case 5:
            return "#0000DF";
        case 6:
            return "#8F008F";
        case 7:
            return "#EFD700";
        case 8:
            return "#008F00";
        case 9:
            return "#3737AF";
        case 10:
            return "#BF4F4F";
        case 11:
            return "#77EF77";
        case 12:
            return "#3FAF3F";
        case 13:
            return "#A71770";
        case 14:
            return "#8FCF27";
        case 15:
            return "#4F7FEF";
        case 16:
            return "#771FAF";
        case 17:
            return "#97FF2F";
        default:
            return "#FF7F7F";
    }
}
</script>
</body>
</html>
